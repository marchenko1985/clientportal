# Cache upstream responses for 1 week.
# Used for near-static data: instrument definitions, contract details, etc.
proxy_cache       cache;
proxy_cache_valid 200 1w;               # Only cache HTTP 200 (errors are never cached)
proxy_cache_key   "$scheme$host$request_uri"; # Include host so cache is safe across multiple vhosts
proxy_cache_lock  on;                   # One request fills cache; others wait (prevents stampede)
proxy_cache_methods GET HEAD;           # Only cache safe, idempotent methods

# Prevent upstream Set-Cookie / cache-control headers from bypassing or poisoning the cache.
# These reference-data endpoints have no per-client state, so cookies are irrelevant.
proxy_hide_header    Set-Cookie;
proxy_ignore_headers Set-Cookie Cache-Control Expires;

# Restore security headers: the add_header below blocks server-level add_header inheritance.
# See snippets/security-headers.conf for the full explanation.
include /etc/nginx/snippets/security-headers.conf;

# HIT=served from cache, MISS=upstream queried, EXPIRED=re-fetched, BYPASS=cache skipped
add_header X-Cache-Status $upstream_cache_status always;
