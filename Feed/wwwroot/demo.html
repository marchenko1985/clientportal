<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>WebSocket Debug Demo</title>
  </head>
  <body>
    <h2>WebSocket Debug Demo</h2>
    <p id="ws-status">WS: connecting...</p>

    <h3>Subscribe</h3>
    <form id="subscribe-form">
      <label>
        Conid:
        <input id="conid-input" type="number" value="265598" />
      </label>
      <p>Fields:</p>
      <label><input type="checkbox" class="field" value="31" checked />31</label>
      <label><input type="checkbox" class="field" value="84" checked />84</label>
      <label><input type="checkbox" class="field" value="86" checked />86</label>
      <label><input type="checkbox" class="field" value="82" />82</label>
      <label><input type="checkbox" class="field" value="83" />83</label>
      <label><input type="checkbox" class="field" value="87" />87</label>
      <label><input type="checkbox" class="field" value="70" />70</label>
      <label><input type="checkbox" class="field" value="71" />71</label>
      <label><input type="checkbox" class="field" value="7308" />7308</label>
      <label><input type="checkbox" class="field" value="7309" />7309</label>
      <label><input type="checkbox" class="field" value="7310" />7310</label>
      <label><input type="checkbox" class="field" value="7311" />7311</label>
      <label><input type="checkbox" class="field" value="7633" />7633</label>
      <p>
        <label>
          Message:
          <input id="message-input" type="text" size="80" />
        </label>
      </p>
      <button type="submit">Send</button>
    </form>

    <h3>Messages Log</h3>
    <textarea id="log" rows="20" cols="120" readonly></textarea>

    <script>
      const wsStatus = document.getElementById("ws-status");
      const subscribeForm = document.getElementById("subscribe-form");
      const conidInput = document.getElementById("conid-input");
      const messageInput = document.getElementById("message-input");
      const fields = Array.from(document.querySelectorAll(".field"));
      const log = document.getElementById("log");

      let ws = null;

      function logLine(prefix, text) {
        const ts = new Date().toISOString();
        log.value += `[${ts}] ${prefix} ${text}\n`;
        log.scrollTop = log.scrollHeight;
      }

      function selectedFields() {
        return fields.filter((x) => x.checked).map((x) => x.value);
      }

      function buildSubscribeMessage() {
        const conid = conidInput.value.trim();
        const f = selectedFields();
        if (!conid || f.length === 0) return "";
        return `smd+${conid}+${JSON.stringify({ fields: f })}`;
      }

      function refreshMessageInput() {
        messageInput.value = buildSubscribeMessage();
      }

      function connectWs() {
        const scheme = location.protocol === "https:" ? "wss" : "ws";
        ws = new WebSocket(`${scheme}://${location.host}/ws`);

        ws.onopen = () => {
          wsStatus.textContent = "WS: connected";
          logLine("OPEN", "connected");
        };

        ws.onmessage = ({ data }) => {
          logLine("IN", String(data));
        };

        ws.onerror = () => {
          wsStatus.textContent = "WS: error";
          logLine("ERR", "websocket error");
        };

        ws.onclose = () => {
          wsStatus.textContent = "WS: closed";
          logLine("CLOSE", "closed");
        };
      }

      subscribeForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const msg = messageInput.value.trim();
        if (!msg) return;
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          logLine("WARN", "ws is not open");
          return;
        }
        ws.send(msg);
        logLine("OUT", msg);
      });

      conidInput.addEventListener("input", refreshMessageInput);
      for (const cb of fields) cb.addEventListener("change", refreshMessageInput);

      refreshMessageInput();
      connectWs();
    </script>
  </body>
</html>
